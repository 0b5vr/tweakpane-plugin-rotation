!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TweakpaneRotationInputPlugin={})}(this,(function(t){"use strict";function e(t){return null==t}const i={alreadydisposed:()=>"View has been already disposed",invalidparams:t=>`Invalid parameters for '${t.name}'`,nomatchingcontroller:t=>`No matching controller for '${t.key}'`,nomatchingview:t=>`No matching view for '${JSON.stringify(t.params)}'`,notbindable:()=>"Value is not bindable",propertynotfound:t=>`Property '${t.name}' not found`,shouldneverhappen:()=>"This error should never happen"};class n{constructor(t){var e;this.message=null!==(e=i[t.type](t.context))&&void 0!==e?e:"Unexpected error",this.name=this.constructor.name,this.stack=new Error(this.message).stack,this.type=t.type}static alreadyDisposed(){return new n({type:"alreadydisposed"})}static notBindable(){return new n({type:"notbindable"})}static propertyNotFound(t){return new n({type:"propertynotfound",context:{name:t}})}static shouldNeverHappen(){return new n({type:"shouldneverhappen"})}}class o{constructor(){this.observers_={}}on(t,e){let i=this.observers_[t];return i||(i=this.observers_[t]=[]),i.push({handler:e}),this}off(t,e){const i=this.observers_[t];return i&&(this.observers_[t]=i.filter((t=>t.handler!==e))),this}emit(t,e){const i=this.observers_[t];i&&i.forEach((t=>{t.handler(e)}))}}const s="tp";function r(t){return(e,i)=>[s,"-",t,"v",e?`_${e}`:"",i?`-${i}`:""].join("")}function a(t){return t.rawValue}function l(t,e){var i,n;t.emitter.on("change",(i=a,n=e,t=>n(i(t)))),e(t.rawValue)}function h(t,e,i){l(t.value(e),i)}function c(t,e){return i=>{!function(t,e,i){i?t.classList.add(e):t.classList.remove(e)}(t,e,i)}}class u{constructor(t,e){var i;this.constraint_=null==e?void 0:e.constraint,this.equals_=null!==(i=null==e?void 0:e.equals)&&void 0!==i?i:(t,e)=>t===e,this.emitter=new o,this.rawValue_=t}get constraint(){return this.constraint_}get rawValue(){return this.rawValue_}set rawValue(t){this.setRawValue(t,{forceEmit:!1,last:!0})}setRawValue(t,e){const i=null!=e?e:{forceEmit:!1,last:!0},n=this.constraint_?this.constraint_.constrain(t):t;(!this.equals_(this.rawValue_,n)||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.rawValue_=n,this.emitter.emit("change",{options:i,rawValue:n,sender:this}))}}class d{constructor(t){this.emitter=new o,this.value_=t}get rawValue(){return this.value_}set rawValue(t){this.setRawValue(t,{forceEmit:!1,last:!0})}setRawValue(t,e){const i=null!=e?e:{forceEmit:!1,last:!0};(this.value_!==t||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.value_=t,this.emitter.emit("change",{options:i,rawValue:this.value_,sender:this}))}}function p(t,e){const i=null==e?void 0:e.constraint,n=null==e?void 0:e.equals;return i||n?new u(t,e):new d(t)}class v{constructor(t){this.emitter=new o,this.valMap_=t;for(const t in this.valMap_){this.valMap_[t].emitter.on("change",(()=>{this.emitter.emit("change",{key:t,sender:this})}))}}static createCore(t){return Object.keys(t).reduce(((e,i)=>Object.assign(e,{[i]:p(t[i])})),{})}static fromObject(t){const e=this.createCore(t);return new v(e)}get(t){return this.valMap_[t].rawValue}set(t,e){this.valMap_[t].rawValue=e}value(t){return this.valMap_[t]}}function m(t){return e=>i=>{if(!e&&void 0===i)return{succeeded:!1,value:void 0};if(e&&void 0===i)return{succeeded:!0,value:void 0};const n=t(i);return void 0!==n?{succeeded:!0,value:n}:{succeeded:!1,value:void 0}}}function _(t){return{custom:e=>m(e)(t),boolean:m((t=>"boolean"==typeof t?t:void 0))(t),number:m((t=>"number"==typeof t?t:void 0))(t),string:m((t=>"string"==typeof t?t:void 0))(t),function:m((t=>"function"==typeof t?t:void 0))(t),constant:e=>m((t=>t===e?e:void 0))(t),raw:m((t=>t))(t),object:e=>m((t=>{var i;if(null!==(i=t)&&"object"==typeof i)return function(t,e){return Object.keys(e).reduce(((i,n)=>{if(void 0===i)return;const o=(0,e[n])(t[n]);return o.succeeded?Object.assign(Object.assign({},i),{[n]:o.value}):void 0}),{})}(t,e)}))(t),array:e=>m((t=>{var i;if(Array.isArray(t))return i=e,t.reduce(((t,e)=>{if(void 0===t)return;const n=i(e);return n.succeeded&&void 0!==n.value?[...t,n.value]:void 0}),[])}))(t)}}const g={optional:_(!0),required:_(!1)};function w(t,e){const i=g.required.object(e)(t);return i.succeeded?i.value:void 0}const b="http://www.w3.org/2000/svg";function f(t){t.offsetHeight}class y extends v{constructor(t){super(t)}static create(t){const e={completed:!0,expanded:t,expandedHeight:null,shouldFixHeight:!1,temporaryExpanded:null},i=v.createCore(e);return new y(i)}get styleExpanded(){var t;return null!==(t=this.get("temporaryExpanded"))&&void 0!==t?t:this.get("expanded")}get styleHeight(){if(!this.styleExpanded)return"0";const t=this.get("expandedHeight");return this.get("shouldFixHeight")&&!e(t)?`${t}px`:"auto"}bindExpandedClass(t,e){h(this,"expanded",(()=>{this.styleExpanded?t.classList.add(e):t.classList.remove(e)}))}}function x(t,e){e.style.height=t.styleHeight}function z(t,i){t.value("expanded").emitter.on("beforechange",(()=>{t.set("completed",!1),e(t.get("expandedHeight"))&&t.set("expandedHeight",function(t,e){let i=0;return function(t,e){const i=t.style.transition;t.style.transition="none",e(),t.style.transition=i}(e,(()=>{t.set("expandedHeight",null),t.set("temporaryExpanded",!0),f(e),i=e.clientHeight,t.set("temporaryExpanded",null),f(e)})),i}(t,i)),t.set("shouldFixHeight",!0),f(i)})),t.emitter.on("change",(()=>{x(t,i)})),x(t,i),i.addEventListener("transitionend",(e=>{"height"===e.propertyName&&(t.set("shouldFixHeight",!1),t.set("expandedHeight",null),t.set("completed",!0))}))}class A{constructor(t){this.constraints=t}constrain(t){return this.constraints.reduce(((t,e)=>e.constrain(t)),t)}}class C{constructor(t){this.maxValue=t.max,this.minValue=t.min}constrain(t){let i=t;return e(this.minValue)||(i=Math.max(i,this.minValue)),e(this.maxValue)||(i=Math.min(i,this.maxValue)),i}}class E{constructor(t){this.step=t}constrain(t){return(t<0?-Math.round(-t/this.step):Math.round(t/this.step))*this.step}}const L=r("pop");class k{constructor(t,e){this.element=t.createElement("div"),this.element.classList.add(L()),e.viewProps.bindClassModifiers(this.element),l(e.shows,c(this.element,L(void 0,"v")))}}class M{constructor(t,e){this.shows=p(!1),this.viewProps=e.viewProps,this.view=new k(t,{shows:this.shows,viewProps:this.viewProps})}}class P{constructor(t){this.text=t}evaluate(){return Number(this.text)}toString(){return this.text}}const V={"**":(t,e)=>Math.pow(t,e),"*":(t,e)=>t*e,"/":(t,e)=>t/e,"%":(t,e)=>t%e,"+":(t,e)=>t+e,"-":(t,e)=>t-e,"<<":(t,e)=>t<<e,">>":(t,e)=>t>>e,">>>":(t,e)=>t>>>e,"&":(t,e)=>t&e,"^":(t,e)=>t^e,"|":(t,e)=>t|e};class B{constructor(t,e,i){this.left=e,this.operator=t,this.right=i}evaluate(){const t=V[this.operator];if(!t)throw new Error(`unexpected binary operator: '${this.operator}`);return t(this.left.evaluate(),this.right.evaluate())}toString(){return["b(",this.left.toString(),this.operator,this.right.toString(),")"].join(" ")}}const F={"+":t=>t,"-":t=>-t,"~":t=>~t};class R{constructor(t,e){this.operator=t,this.expression=e}evaluate(){const t=F[this.operator];if(!t)throw new Error(`unexpected unary operator: '${this.operator}`);return t(this.expression.evaluate())}toString(){return["u(",this.operator,this.expression.toString(),")"].join(" ")}}function S(t){return(e,i)=>{for(let n=0;n<t.length;n++){const o=t[n](e,i);if(""!==o)return o}return""}}function j(t,e){var i;const n=t.substr(e).match(/^\s+/);return null!==(i=n&&n[0])&&void 0!==i?i:""}function K(t,e){var i;const n=t.substr(e).match(/^[0-9]+/);return null!==(i=n&&n[0])&&void 0!==i?i:""}function q(t,e){const i=t.substr(e,1);if(e+=1,"e"!==i.toLowerCase())return"";const n=function(t,e){const i=K(t,e);if(""!==i)return i;const n=t.substr(e,1);if("-"!==n&&"+"!==n)return"";const o=K(t,e+=1);return""===o?"":n+o}(t,e);return""===n?"":i+n}function D(t,e){const i=t.substr(e,1);if("0"===i)return i;const n=function(t,e){const i=t.substr(e,1);return i.match(/^[1-9]$/)?i:""}(t,e);return e+=n.length,""===n?"":n+K(t,e)}const I=S([function(t,e){const i=D(t,e);if(e+=i.length,""===i)return"";const n=t.substr(e,1);if(e+=n.length,"."!==n)return"";const o=K(t,e);return i+n+o+q(t,e+=o.length)},function(t,e){const i=t.substr(e,1);if(e+=i.length,"."!==i)return"";const n=K(t,e);return e+=n.length,""===n?"":i+n+q(t,e)},function(t,e){const i=D(t,e);return e+=i.length,""===i?"":i+q(t,e)}]);const N=S([function(t,e){const i=t.substr(e,2);if(e+=i.length,"0b"!==i.toLowerCase())return"";const n=function(t,e){var i;const n=t.substr(e).match(/^[01]+/);return null!==(i=n&&n[0])&&void 0!==i?i:""}(t,e);return""===n?"":i+n},function(t,e){const i=t.substr(e,2);if(e+=i.length,"0o"!==i.toLowerCase())return"";const n=function(t,e){var i;const n=t.substr(e).match(/^[0-7]+/);return null!==(i=n&&n[0])&&void 0!==i?i:""}(t,e);return""===n?"":i+n},function(t,e){const i=t.substr(e,2);if(e+=i.length,"0x"!==i.toLowerCase())return"";const n=function(t,e){var i;const n=t.substr(e).match(/^[0-9a-f]+/i);return null!==(i=n&&n[0])&&void 0!==i?i:""}(t,e);return""===n?"":i+n}]),T=S([N,I]);function X(t,e){return function(t,e){const i=T(t,e);return e+=i.length,""===i?null:{evaluable:new P(i),cursor:e}}(t,e)||function(t,e){const i=t.substr(e,1);if(e+=i.length,"("!==i)return null;const n=Z(t,e);if(!n)return null;e=n.cursor,e+=j(t,e).length;const o=t.substr(e,1);return e+=o.length,")"!==o?null:{evaluable:n.evaluable,cursor:e}}(t,e)}function Y(t,e,i){i+=j(e,i).length;const n=t.filter((t=>e.startsWith(t,i)))[0];return n?(i+=n.length,{cursor:i+=j(e,i).length,operator:n}):null}const H=[["**"],["*","/","%"],["+","-"],["<<",">>>",">>"],["&"],["^"],["|"]].reduce(((t,e)=>function(t,e){return(i,n)=>{const o=t(i,n);if(!o)return null;n=o.cursor;let s=o.evaluable;for(;;){const o=Y(e,i,n);if(!o)break;n=o.cursor;const r=t(i,n);if(!r)return null;n=r.cursor,s=new B(o.operator,s,r.evaluable)}return s?{cursor:n,evaluable:s}:null}}(t,e)),(function t(e,i){const n=X(e,i);if(n)return n;const o=e.substr(i,1);if(i+=o.length,"+"!==o&&"-"!==o&&"~"!==o)return null;const s=t(e,i);return s?{cursor:i=s.cursor,evaluable:new R(o,s.evaluable)}:null}));function Z(t,e){return e+=j(t,e).length,H(t,e)}function $(t){var e;const i=function(t){const e=Z(t,0);return e?e.cursor+j(t,e.cursor).length!==t.length?null:e.evaluable:null}(t);return null!==(e=null==i?void 0:i.evaluate())&&void 0!==e?e:null}function U(t){return e=>e.toFixed(Math.max(Math.min(t,20),0))}function O({primary:t,secondary:e,forward:i,backward:n}){let o=!1;function s(t){o||(o=!0,t(),o=!1)}t.emitter.on("change",(n=>{s((()=>{e.setRawValue(i(t,e),n.options)}))})),e.emitter.on("change",(o=>{s((()=>{t.setRawValue(n(t,e),o.options)})),s((()=>{e.setRawValue(i(t,e),o.options)}))})),s((()=>{e.setRawValue(i(t,e),{forceEmit:!1,last:!0})}))}function Q(t,e){const i=t*(e.altKey?.1:1)*(e.shiftKey?10:1);return e.upKey?+i:e.downKey?-i:0}function J(t){return{altKey:t.altKey,downKey:"ArrowDown"===t.key,shiftKey:t.shiftKey,upKey:"ArrowUp"===t.key}}function W(t,e){const i=e.ownerDocument.defaultView,n=e.getBoundingClientRect();return{x:t.pageX-((i&&i.scrollX||0)+n.left),y:t.pageY-((i&&i.scrollY||0)+n.top)}}class G{constructor(t){this.lastTouch_=null,this.onDocumentMouseMove_=this.onDocumentMouseMove_.bind(this),this.onDocumentMouseUp_=this.onDocumentMouseUp_.bind(this),this.onMouseDown_=this.onMouseDown_.bind(this),this.onTouchEnd_=this.onTouchEnd_.bind(this),this.onTouchMove_=this.onTouchMove_.bind(this),this.onTouchStart_=this.onTouchStart_.bind(this),this.elem_=t,this.emitter=new o,t.addEventListener("touchstart",this.onTouchStart_,{passive:!1}),t.addEventListener("touchmove",this.onTouchMove_,{passive:!0}),t.addEventListener("touchend",this.onTouchEnd_),t.addEventListener("mousedown",this.onMouseDown_)}computePosition_(t){const e=this.elem_.getBoundingClientRect();return{bounds:{width:e.width,height:e.height},point:t?{x:t.x,y:t.y}:null}}onMouseDown_(t){var e;t.preventDefault(),null===(e=t.currentTarget)||void 0===e||e.focus();const i=this.elem_.ownerDocument;i.addEventListener("mousemove",this.onDocumentMouseMove_),i.addEventListener("mouseup",this.onDocumentMouseUp_),this.emitter.emit("down",{altKey:t.altKey,data:this.computePosition_(W(t,this.elem_)),sender:this,shiftKey:t.shiftKey})}onDocumentMouseMove_(t){this.emitter.emit("move",{altKey:t.altKey,data:this.computePosition_(W(t,this.elem_)),sender:this,shiftKey:t.shiftKey})}onDocumentMouseUp_(t){const e=this.elem_.ownerDocument;e.removeEventListener("mousemove",this.onDocumentMouseMove_),e.removeEventListener("mouseup",this.onDocumentMouseUp_),this.emitter.emit("up",{altKey:t.altKey,data:this.computePosition_(W(t,this.elem_)),sender:this,shiftKey:t.shiftKey})}onTouchStart_(t){t.preventDefault();const e=t.targetTouches.item(0),i=this.elem_.getBoundingClientRect();this.emitter.emit("down",{altKey:t.altKey,data:this.computePosition_(e?{x:e.clientX-i.left,y:e.clientY-i.top}:void 0),sender:this,shiftKey:t.shiftKey}),this.lastTouch_=e}onTouchMove_(t){const e=t.targetTouches.item(0),i=this.elem_.getBoundingClientRect();this.emitter.emit("move",{altKey:t.altKey,data:this.computePosition_(e?{x:e.clientX-i.left,y:e.clientY-i.top}:void 0),sender:this,shiftKey:t.shiftKey}),this.lastTouch_=e}onTouchEnd_(t){var e;const i=null!==(e=t.targetTouches.item(0))&&void 0!==e?e:this.lastTouch_,n=this.elem_.getBoundingClientRect();this.emitter.emit("up",{altKey:t.altKey,data:this.computePosition_(i?{x:i.clientX-n.left,y:i.clientY-n.top}:void 0),sender:this,shiftKey:t.shiftKey})}}const tt=r("txt");class et{constructor(t,e){this.onChange_=this.onChange_.bind(this),this.props_=e.props,this.props_.emitter.on("change",this.onChange_),this.element=t.createElement("div"),this.element.classList.add(tt(),tt(void 0,"num")),e.arrayPosition&&this.element.classList.add(tt(void 0,e.arrayPosition)),e.viewProps.bindClassModifiers(this.element);const i=t.createElement("input");i.classList.add(tt("i")),i.type="text",e.viewProps.bindDisabled(i),this.element.appendChild(i),this.inputElement=i,this.onDraggingChange_=this.onDraggingChange_.bind(this),this.dragging_=e.dragging,this.dragging_.emitter.on("change",this.onDraggingChange_),this.element.classList.add(tt()),this.inputElement.classList.add(tt("i"));const n=t.createElement("div");n.classList.add(tt("k")),this.element.appendChild(n),this.knobElement=n;const o=t.createElementNS(b,"svg");o.classList.add(tt("g")),this.knobElement.appendChild(o);const s=t.createElementNS(b,"path");s.classList.add(tt("gb")),o.appendChild(s),this.guideBodyElem_=s;const a=t.createElementNS(b,"path");a.classList.add(tt("gh")),o.appendChild(a),this.guideHeadElem_=a;const l=t.createElement("div");l.classList.add(r("tt")()),this.knobElement.appendChild(l),this.tooltipElem_=l,e.value.emitter.on("change",this.onChange_),this.value=e.value,this.refresh()}onDraggingChange_(t){if(null===t.rawValue)return void this.element.classList.remove(tt(void 0,"drg"));this.element.classList.add(tt(void 0,"drg"));const e=t.rawValue/this.props_.get("draggingScale"),i=e+(e>0?-1:e<0?1:0),n=(o=-i,s=-4,r=4,Math.min(Math.max(o,s),r));var o,s,r;this.guideHeadElem_.setAttributeNS(null,"d",[`M ${i+n},0 L${i},4 L${i+n},8`,`M ${e},-1 L${e},9`].join(" ")),this.guideBodyElem_.setAttributeNS(null,"d",`M 0,4 L${e},4`);const a=this.props_.get("formatter");this.tooltipElem_.textContent=a(this.value.rawValue),this.tooltipElem_.style.left=`${e}px`}refresh(){const t=this.props_.get("formatter");this.inputElement.value=t(this.value.rawValue)}onChange_(){this.refresh()}}class it{constructor(t,e){this.originRawValue_=0,this.onInputChange_=this.onInputChange_.bind(this),this.onInputKeyDown_=this.onInputKeyDown_.bind(this),this.onInputKeyUp_=this.onInputKeyUp_.bind(this),this.onPointerDown_=this.onPointerDown_.bind(this),this.onPointerMove_=this.onPointerMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.baseStep_=e.baseStep,this.parser_=e.parser,this.props=e.props,this.value=e.value,this.viewProps=e.viewProps,this.dragging_=p(null),this.view=new et(t,{arrayPosition:e.arrayPosition,dragging:this.dragging_,props:this.props,value:this.value,viewProps:this.viewProps}),this.view.inputElement.addEventListener("change",this.onInputChange_),this.view.inputElement.addEventListener("keydown",this.onInputKeyDown_),this.view.inputElement.addEventListener("keyup",this.onInputKeyUp_);const i=new G(this.view.knobElement);i.emitter.on("down",this.onPointerDown_),i.emitter.on("move",this.onPointerMove_),i.emitter.on("up",this.onPointerUp_)}onInputChange_(t){const i=t.currentTarget.value,n=this.parser_(i);e(n)||(this.value.rawValue=n),this.view.refresh()}onInputKeyDown_(t){const e=Q(this.baseStep_,J(t));0!==e&&this.value.setRawValue(this.value.rawValue+e,{forceEmit:!1,last:!1})}onInputKeyUp_(t){0!==Q(this.baseStep_,J(t))&&this.value.setRawValue(this.value.rawValue,{forceEmit:!0,last:!0})}onPointerDown_(){this.originRawValue_=this.value.rawValue,this.dragging_.rawValue=0}computeDraggingValue_(t){if(!t.point)return null;const e=t.point.x-t.bounds.width/2;return this.originRawValue_+e*this.props.get("draggingScale")}onPointerMove_(t){const e=this.computeDraggingValue_(t.data);null!==e&&(this.value.setRawValue(e,{forceEmit:!1,last:!1}),this.dragging_.rawValue=this.value.rawValue-this.originRawValue_)}onPointerUp_(t){const e=this.computeDraggingValue_(t.data);null!==e&&(this.value.setRawValue(e,{forceEmit:!0,last:!0}),this.dragging_.rawValue=null)}}function nt(t){if("inline"===t||"popup"===t)return t}function ot(t){const e=g;return e.required.object({max:e.optional.number,min:e.optional.number,step:e.optional.number})(t).value}class st{constructor(t){this.components=t.components,this.asm_=t.assembly}constrain(t){const e=this.asm_.toComponents(t).map(((t,e)=>{var i,n;return null!==(n=null===(i=this.components[e])||void 0===i?void 0:i.constrain(t))&&void 0!==n?n:t}));return this.asm_.fromComponents(e)}}const rt=r("pndtxt");class at{constructor(t,e){this.textViews=e.textViews,this.element=t.createElement("div"),this.element.classList.add(rt()),this.textViews.forEach((e=>{const i=t.createElement("div");i.classList.add(rt("a")),i.appendChild(e.element),this.element.appendChild(i)}))}}class lt{constructor(t,e){this.value=e.value,this.viewProps=e.viewProps,this.acs_=e.axes.map(((i,n)=>function(t,e,i){return new it(t,{arrayPosition:0===i?"fst":i===e.axes.length-1?"lst":"mid",baseStep:e.axes[i].baseStep,parser:e.parser,props:e.axes[i].textProps,value:p(0,{constraint:e.axes[i].constraint}),viewProps:e.viewProps})}(t,e,n))),this.acs_.forEach(((t,i)=>{O({primary:this.value,secondary:t.value,forward:t=>e.assembly.toComponents(t.rawValue)[i],backward:(t,n)=>{const o=e.assembly.toComponents(t.rawValue);return o[i]=n.rawValue,e.assembly.fromComponents(o)}})})),this.view=new at(t,{textViews:this.acs_.map((t=>t.view))})}}class ht{multiply(t){return this.format(this.quat.multiply(t.quat))}premultiply(t){return this.format(t.multiply(this))}slerp(t,e){return this.format(this.quat.slerp(t.quat,e))}}function ct(t,e,i){return Math.min(Math.max(t,e),i)}function ut(t,e){return t-function(t,e){return Math.floor(t/e)*e}(t,e)}function dt(t){return ut(t+Math.PI,2*Math.PI)-Math.PI}class pt extends ht{constructor(t,e,i,n,o){super(),this.x=null!=t?t:0,this.y=null!=e?e:0,this.z=null!=i?i:0,this.order=null!=n?n:"XYZ",this.unit=null!=o?o:"rad"}static fromQuaternion(t,e,i){const n=t.toMat3(),[o,s,r,a]="XYZ"===e?[0,1,2,1]:"XZY"===e?[0,2,1,-1]:"YXZ"===e?[1,0,2,-1]:"YZX"===e?[1,2,0,1]:"ZXY"===e?[2,0,1,1]:[2,1,0,-1],l=[0,0,0],h=n[r+3*o];return l[s]=-a*Math.asin(ct(h,-1,1)),Math.abs(h)<.999999?(l[o]=a*Math.atan2(n[r+3*s],n[4*r]),l[r]=a*Math.atan2(n[s+3*o],n[4*o])):l[o]=a*Math.atan2(-n[s+3*r],n[4*s]),Math.abs(l[o])+Math.abs(l[r])>Math.PI&&(l[o]=dt(l[o]+Math.PI),l[s]=dt(Math.PI-l[s]),l[r]=dt(l[r]+Math.PI)),new pt(...l,e).reunit(i)}get quat(){return vt.fromEuler(this)}getComponents(){return[this.x,this.y,this.z]}toEuler(t,e){return this.reorder(t).reunit(e)}format(t){return t instanceof pt?t.reorder(this.order):t.toEuler(this.order,this.unit)}reorder(t){return t===this.order?this:this.quat.toEuler(t,this.unit)}reunit(t){const e={deg:Math.PI/180,rad:1,turn:2*Math.PI}[this.unit]*{deg:180/Math.PI,rad:1,turn:.5/Math.PI}[t];return new pt(e*this.x,e*this.y,e*this.z,this.order,t)}}class vt extends ht{constructor(t,e,i,n){super(),this.x=null!=t?t:0,this.y=null!=e?e:0,this.z=null!=i?i:0,this.w=null!=n?n:1}static fromAxisAngle(t,e){const i=e/2,n=Math.sin(i);return new vt(t.x*n,t.y*n,t.z*n,Math.cos(i))}static fromEuler(t){const e=t.reunit("rad"),[i,n,o,s]="XYZ"===e.order?[0,1,2,1]:"XZY"===e.order?[0,2,1,-1]:"YXZ"===e.order?[1,0,2,-1]:"YZX"===e.order?[1,2,0,1]:"ZXY"===e.order?[2,0,1,1]:[2,1,0,-1],r=e.getComponents(),a=.5*r[i],l=.5*s*r[n],h=.5*r[o],c=Math.cos(a),u=Math.cos(l),d=Math.cos(h),p=Math.sin(a),v=Math.sin(l),m=Math.sin(h),_=[0,0,0,d*u*c+m*v*p];return _[i]=d*u*p-m*v*c,_[n]=s*(d*v*c+m*u*p),_[o]=m*u*c-d*v*p,new vt(..._)}static lookRotation(t,e){const{normal:i,tangent:n,binormal:o}=t.orthoNormalize(e),s=o.x,r=n.x,a=i.x,l=o.y,h=n.y,c=i.y,u=o.z,d=n.z,p=i.z,v=s+h+p;if(v>0){const t=.5/Math.sqrt(v+1);return new vt((d-c)*t,(a-u)*t,(l-r)*t,.25/t)}if(s>h&&s>p){const t=2*Math.sqrt(1+s-h-p);return new vt(.25*t,(r+l)/t,(a+u)/t,(d-c)/t)}if(h>p){const t=2*Math.sqrt(1+h-s-p);return new vt((r+l)/t,.25*t,(c+d)/t,(a-u)/t)}{const t=2*Math.sqrt(1+p-s-h);return new vt((a+u)/t,(c+d)/t,.25*t,(l-r)/t)}}get quat(){return this}getComponents(){return[this.x,this.y,this.z,this.w]}toEuler(t,e){return pt.fromQuaternion(this,t,e)}get lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}get length(){return Math.sqrt(this.lengthSq)}get normalized(){const t=this.length;return 0===t?new vt:new vt(this.x/t,this.y/t,this.z/t,this.w/t)}get negated(){return new vt(-this.x,-this.y,-this.z,-this.w)}get ban360s(){return this.w<0?this.negated:this}multiply(t){const e=t.quat;return new vt(this.w*e.x+this.x*e.w+this.y*e.z-this.z*e.y,this.w*e.y-this.x*e.z+this.y*e.w+this.z*e.x,this.w*e.z+this.x*e.y-this.y*e.x+this.z*e.w,this.w*e.w-this.x*e.x-this.y*e.y-this.z*e.z)}format(t){return t.quat}slerp(t,e){let i=t.quat;if(0===e)return this;if(1===e)return i;const n=this.ban360s;i=i.ban360s;let o=n.w*i.w+n.x*i.x+n.y*i.y+n.z*i.z;if(o<0&&(i=i.negated,o=-o),o>=1)return n;const s=1-o*o;if(s<=Number.EPSILON){const t=1-e;return new vt(t*n.x+e*i.x,t*n.y+e*i.y,t*n.z+e*i.z,t*n.w+e*i.w).normalized}const r=Math.sqrt(s),a=Math.atan2(r,o),l=Math.sin((1-e)*a)/r,h=Math.sin(e*a)/r;return new vt(n.x*l+i.x*h,n.y*l+i.y*h,n.z*l+i.z*h,n.w*l+i.w*h)}toMat3(){const{x:t,y:e,z:i,w:n}=this;return[1-2*e*e-2*i*i,2*t*e+2*i*n,2*t*i-2*e*n,2*t*e-2*i*n,1-2*t*t-2*i*i,2*e*i+2*t*n,2*t*i+2*e*n,2*e*i-2*t*n,1-2*t*t-2*e*e]}}class mt{constructor(){this.offset=[0,0,-5],this.fov=30,this.aspect=1,this.viewport=[0,0,1,1]}project(t){const e=.5*(this.viewport[0]+this.viewport[2]),i=.5*(this.viewport[1]+this.viewport[3]),n=this.viewport[2]-this.viewport[0],o=this.viewport[3]-this.viewport[1],s=1/Math.tan(this.fov*Math.PI/360),r=-(t.z+this.offset[2]);return[e+(t.x+this.offset[0])/r*s*n*.5/this.aspect,i-(t.y+this.offset[1])/r*s*o*.5]}}class _t{constructor(t,e,i){this.element=t.createElementNS(b,"path"),this.vertices=e,this.projector=i}setRotation(t){let e="";return this.vertices.forEach(((i,n)=>{const o=i.applyQuaternion(t),[s,r]=this.projector.project(o);e+=`${0===n?"M":"L"}${s} ${r}`})),this.element.setAttributeNS(null,"d",e),this}}class gt{constructor(t,e,i){this.x=null!=t?t:0,this.y=null!=e?e:0,this.z=null!=i?i:0}getComponents(){return[this.x,this.y,this.z]}get lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}get length(){return Math.sqrt(this.lengthSq)}get normalized(){const t=this.length;return 0===t?new gt:new gt(this.x/t,this.y/t,this.z/t)}get negated(){return new gt(-this.x,-this.y,-this.z)}add(t){return new gt(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return new gt(this.x-t.x,this.y-t.y,this.z-t.z)}scale(t){return new gt(this.x*t,this.y*t,this.z*t)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new gt(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}orthoNormalize(t){const e=this.normalized;t=t.normalized;let i=e.dot(t);1===i&&(t=Math.abs(e.y)>Math.abs(e.z)?new gt(0,0,1):new gt(0,1,0),i=e.dot(t));const n=(t=t.sub(e.scale(i)).normalized).cross(e);return{normal:e,tangent:t,binormal:n}}applyQuaternion(t){const e=t.w*this.x+t.y*this.z-t.z*this.y,i=t.w*this.y+t.z*this.x-t.x*this.z,n=t.w*this.z+t.x*this.y-t.y*this.x,o=-t.x*this.x-t.y*this.y-t.z*this.z;return new gt(e*t.w+o*-t.x+i*-t.z-n*-t.y,i*t.w+o*-t.y+n*-t.x-e*-t.z,n*t.w+o*-t.z+e*-t.y-i*-t.x)}}function wt(t,e){const i=e.z>0?new vt(0,0,0,1):new vt(0,0,1,0);return Math.abs(t.z)>.9999?i:vt.lookRotation(t,e)}function bt(t,e,i,n,o,s=1){const r=[];for(let a=0;a<i;a++){const l=t+e*a/(i-1),h=new gt;h[n]=s*Math.cos(l),h[o]=s*Math.sin(l),r.push(h)}return r}const ft=r("rotationgizmo"),yt=new gt(0,0,0),xt=new gt(1,0,0),zt=new gt(0,1,0),At=new gt(0,0,1),Ct=new gt(0,0,-1),Et=new gt(.7,0,0),Lt=new gt(0,.7,0),kt=new gt(0,0,.7),Mt=new gt(-.7,0,0),Pt=new gt(0,-.7,0),Vt=new gt(0,0,-.7),Bt=new vt(0,0,0,1);function Ft(t,e,i){const n=t.createElementNS(b,"g"),o=t.createElementNS(b,"circle");o.classList.add(ft(e)),o.setAttributeNS(null,"cx","0"),o.setAttributeNS(null,"cy","0"),o.setAttributeNS(null,"r","8"),n.appendChild(o);const s=t.createElementNS(b,"text");return s.classList.add(ft("labeltext")),s.setAttributeNS(null,"y","4"),s.setAttributeNS(null,"text-anchor","middle"),s.setAttributeNS(null,"font-size","10"),s.textContent=i,n.appendChild(s),n}class Rt{constructor(t,e){this.onFoldableChange_=this.onFoldableChange_.bind(this),this.onValueChange_=this.onValueChange_.bind(this),this.onModeChange_=this.onModeChange_.bind(this),this.element=t.createElement("div"),this.element.classList.add(ft()),"popup"===e.pickerLayout&&this.element.classList.add(ft(void 0,"p"));const i=t.createElement("div");i.classList.add(ft("p")),e.viewProps.bindTabIndex(i),this.element.appendChild(i),this.padElement=i;const n=t.createElementNS(b,"svg");n.classList.add(ft("g")),this.padElement.appendChild(n),this.svgElem_=n,this.projector_=new mt,this.projector_.viewport=[0,0,136,136];const o=bt(0,Math.PI,33,"x","y"),s=bt(0,2*Math.PI,65,"x","y",1.1);this.xArcB_=new _t(t,o,this.projector_),this.xArcB_.element.classList.add(ft("arcx")),this.svgElem_.appendChild(this.xArcB_.element),this.yArcB_=new _t(t,o,this.projector_),this.yArcB_.element.classList.add(ft("arcy")),this.svgElem_.appendChild(this.yArcB_.element),this.zArcB_=new _t(t,o,this.projector_),this.zArcB_.element.classList.add(ft("arcz")),this.svgElem_.appendChild(this.zArcB_.element),this.xArcBC_=new _t(t,o,this.projector_),this.xArcBC_.element.classList.add(ft("arcc")),this.svgElem_.appendChild(this.xArcBC_.element),this.yArcBC_=new _t(t,o,this.projector_),this.yArcBC_.element.classList.add(ft("arcc")),this.svgElem_.appendChild(this.yArcBC_.element),this.zArcBC_=new _t(t,o,this.projector_),this.zArcBC_.element.classList.add(ft("arcc")),this.svgElem_.appendChild(this.zArcBC_.element);const r=t.createElementNS(b,"g");n.classList.add(ft("axes")),this.svgElem_.appendChild(r),this.axesElem_=r,this.xAxis_=new _t(t,[yt,Et],this.projector_),this.xAxis_.element.classList.add(ft("axisx")),this.axesElem_.appendChild(this.xAxis_.element),this.yAxis_=new _t(t,[yt,Lt],this.projector_),this.yAxis_.element.classList.add(ft("axisy")),this.axesElem_.appendChild(this.yAxis_.element),this.zAxis_=new _t(t,[yt,kt],this.projector_),this.zAxis_.element.classList.add(ft("axisz")),this.axesElem_.appendChild(this.zAxis_.element),this.xnAxis_=new _t(t,[yt,Mt],this.projector_),this.xnAxis_.element.classList.add(ft("axisn")),this.axesElem_.appendChild(this.xnAxis_.element),this.ynAxis_=new _t(t,[yt,Pt],this.projector_),this.ynAxis_.element.classList.add(ft("axisn")),this.axesElem_.appendChild(this.ynAxis_.element),this.znAxis_=new _t(t,[yt,Vt],this.projector_),this.znAxis_.element.classList.add(ft("axisn")),this.axesElem_.appendChild(this.znAxis_.element),this.xArcF_=new _t(t,o,this.projector_),this.xArcF_.element.classList.add(ft("arcx")),this.svgElem_.appendChild(this.xArcF_.element),this.yArcF_=new _t(t,o,this.projector_),this.yArcF_.element.classList.add(ft("arcy")),this.svgElem_.appendChild(this.yArcF_.element),this.zArcF_=new _t(t,o,this.projector_),this.zArcF_.element.classList.add(ft("arcz")),this.svgElem_.appendChild(this.zArcF_.element),this.xArcFC_=new _t(t,o,this.projector_),this.xArcFC_.element.classList.add(ft("arcc")),this.svgElem_.appendChild(this.xArcFC_.element),this.yArcFC_=new _t(t,o,this.projector_),this.yArcFC_.element.classList.add(ft("arcc")),this.svgElem_.appendChild(this.yArcFC_.element),this.zArcFC_=new _t(t,o,this.projector_),this.zArcFC_.element.classList.add(ft("arcc")),this.svgElem_.appendChild(this.zArcFC_.element),this.rArc_=new _t(t,s,this.projector_),this.rArc_.element.classList.add(ft("arcr")),this.rArc_.setRotation(Bt),this.svgElem_.appendChild(this.rArc_.element),this.rArcC_=new _t(t,s,this.projector_),this.rArcC_.element.classList.add(ft("arcc")),this.rArcC_.setRotation(Bt),this.svgElem_.appendChild(this.rArcC_.element);const a=t.createElementNS(b,"g");n.classList.add(ft("labels")),this.svgElem_.appendChild(a),this.labelsElem_=a,this.xLabel=Ft(t,"labelcirclex","X"),this.labelsElem_.appendChild(this.xLabel),this.yLabel=Ft(t,"labelcircley","Y"),this.labelsElem_.appendChild(this.yLabel),this.zLabel=Ft(t,"labelcirclez","Z"),this.labelsElem_.appendChild(this.zLabel),this.xnLabel=Ft(t,"labelcirclen","-X"),this.labelsElem_.appendChild(this.xnLabel),this.ynLabel=Ft(t,"labelcirclen","-Y"),this.labelsElem_.appendChild(this.ynLabel),this.znLabel=Ft(t,"labelcirclen","-Z"),this.labelsElem_.appendChild(this.znLabel);const l=()=>{this.xArcB_.element.classList.add(ft("arcx_hover")),this.xArcF_.element.classList.add(ft("arcx_hover"))},h=()=>{this.xArcB_.element.classList.remove(ft("arcx_hover")),this.xArcF_.element.classList.remove(ft("arcx_hover"))};this.xArcBC_.element.addEventListener("mouseenter",l),this.xArcBC_.element.addEventListener("mouseleave",h),this.xArcFC_.element.addEventListener("mouseenter",l),this.xArcFC_.element.addEventListener("mouseleave",h);const c=()=>{this.yArcB_.element.classList.add(ft("arcy_hover")),this.yArcF_.element.classList.add(ft("arcy_hover"))},u=()=>{this.yArcB_.element.classList.remove(ft("arcy_hover")),this.yArcF_.element.classList.remove(ft("arcy_hover"))};this.yArcBC_.element.addEventListener("mouseenter",c),this.yArcBC_.element.addEventListener("mouseleave",u),this.yArcFC_.element.addEventListener("mouseenter",c),this.yArcFC_.element.addEventListener("mouseleave",u);const d=()=>{this.zArcB_.element.classList.add(ft("arcz_hover")),this.zArcF_.element.classList.add(ft("arcz_hover"))},p=()=>{this.zArcB_.element.classList.remove(ft("arcz_hover")),this.zArcF_.element.classList.remove(ft("arcz_hover"))};this.zArcBC_.element.addEventListener("mouseenter",d),this.zArcBC_.element.addEventListener("mouseleave",p),this.zArcFC_.element.addEventListener("mouseenter",d),this.zArcFC_.element.addEventListener("mouseleave",p);this.rArcC_.element.addEventListener("mouseenter",(()=>{this.rArc_.element.classList.add(ft("arcr_hover"))})),this.rArcC_.element.addEventListener("mouseleave",(()=>{this.rArc_.element.classList.remove(ft("arcr_hover"))})),e.value.emitter.on("change",this.onValueChange_),this.value=e.value,e.mode.emitter.on("change",this.onModeChange_),this.mode_=e.mode,this.update_()}get xArcBElement(){return this.xArcBC_.element}get yArcBElement(){return this.yArcBC_.element}get zArcBElement(){return this.zArcBC_.element}get xArcFElement(){return this.xArcFC_.element}get yArcFElement(){return this.yArcFC_.element}get zArcFElement(){return this.zArcFC_.element}get rArcElement(){return this.rArcC_.element}get allFocusableElements(){return[this.padElement]}update_(){const t=this.value.rawValue.quat.normalized;this.xAxis_.setRotation(t),this.yAxis_.setRotation(t),this.zAxis_.setRotation(t),this.xnAxis_.setRotation(t),this.ynAxis_.setRotation(t),this.znAxis_.setRotation(t);const e=xt.applyQuaternion(t),i=zt.applyQuaternion(t),n=At.applyQuaternion(t),o=e.negated,s=i.negated,r=n.negated;[{el:this.xAxis_.element,v:e},{el:this.yAxis_.element,v:i},{el:this.zAxis_.element,v:n},{el:this.xnAxis_.element,v:o},{el:this.ynAxis_.element,v:s},{el:this.znAxis_.element,v:r}].map((({el:t,v:e})=>(this.axesElem_.removeChild(t),{el:t,v:e}))).sort(((t,e)=>t.v.z-e.v.z)).forEach((({el:t})=>{this.axesElem_.appendChild(t)})),this.xArcB_.setRotation(wt(e,Ct)),this.yArcB_.setRotation(wt(i,Ct)),this.zArcB_.setRotation(wt(n,Ct)),this.xArcBC_.setRotation(wt(e,Ct)),this.yArcBC_.setRotation(wt(i,Ct)),this.zArcBC_.setRotation(wt(n,Ct)),this.xArcF_.setRotation(wt(e,At)),this.yArcF_.setRotation(wt(i,At)),this.zArcF_.setRotation(wt(n,At)),this.xArcFC_.setRotation(wt(e,At)),this.yArcFC_.setRotation(wt(i,At)),this.zArcFC_.setRotation(wt(n,At)),[{el:this.xLabel,v:Et},{el:this.yLabel,v:Lt},{el:this.zLabel,v:kt},{el:this.xnLabel,v:Mt},{el:this.ynLabel,v:Pt},{el:this.znLabel,v:Vt}].forEach((({el:e,v:i})=>{const[n,o]=this.projector_.project(i.applyQuaternion(t));e.setAttributeNS(null,"transform",`translate( ${n}, ${o} )`)})),[{el:this.xLabel,v:e},{el:this.yLabel,v:i},{el:this.zLabel,v:n},{el:this.xnLabel,v:o},{el:this.ynLabel,v:s},{el:this.znLabel,v:r}].map((({el:t,v:e})=>(this.labelsElem_.removeChild(t),{el:t,v:e}))).sort(((t,e)=>t.v.z-e.v.z)).forEach((({el:t})=>{this.labelsElem_.appendChild(t)}))}onValueChange_(){this.update_()}onFoldableChange_(){this.update_()}onModeChange_(){const t=this.mode_.rawValue,e="angle-x"===t?"add":"remove",i="angle-y"===t?"add":"remove",n="angle-z"===t?"add":"remove",o="angle-r"===t?"add":"remove";this.xArcB_.element.classList[e](ft("arcx_active")),this.yArcB_.element.classList[i](ft("arcy_active")),this.zArcB_.element.classList[n](ft("arcz_active")),this.xArcF_.element.classList[e](ft("arcx_active")),this.yArcF_.element.classList[i](ft("arcy_active")),this.zArcF_.element.classList[n](ft("arcz_active")),this.rArc_.element.classList[o](ft("arcr_active"))}}function St(t){return ct(t,0,1)}const jt=1/Math.sqrt(2),Kt=new gt(1,0,0),qt=new gt(0,1,0),Dt=new gt(0,0,1),It=new vt(0,0,0,1),Nt=new vt(jt,0,0,jt),Tt=new vt(0,-jt,0,jt),Xt=new vt(-jt,0,0,jt),Yt=new vt(0,jt,0,jt),Ht=new vt(0,1,0,0);class Zt{constructor(t,e){this.onPadKeyDown_=this.onPadKeyDown_.bind(this),this.onPointerDown_=this.onPointerDown_.bind(this),this.onPointerMove_=this.onPointerMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.value=e.value,this.viewProps=e.viewProps,this.mode_=p("free"),this.view=new Rt(t,{value:this.value,mode:this.mode_,viewProps:this.viewProps,pickerLayout:e.pickerLayout}),this.ptHandler_=new G(this.view.padElement),this.ptHandler_.emitter.on("down",this.onPointerDown_),this.ptHandler_.emitter.on("move",this.onPointerMove_),this.ptHandler_.emitter.on("up",this.onPointerUp_),this.view.padElement.addEventListener("keydown",this.onPadKeyDown_);const i=new G(this.view.xArcBElement);i.emitter.on("down",(()=>this.changeModeIfNotAuto_("angle-x"))),i.emitter.on("up",(()=>this.changeModeIfNotAuto_("free")));const n=new G(this.view.xArcFElement);n.emitter.on("down",(()=>this.changeModeIfNotAuto_("angle-x"))),n.emitter.on("up",(()=>this.changeModeIfNotAuto_("free")));const o=new G(this.view.yArcBElement);o.emitter.on("down",(()=>this.changeModeIfNotAuto_("angle-y"))),o.emitter.on("up",(()=>this.changeModeIfNotAuto_("free")));const s=new G(this.view.yArcFElement);s.emitter.on("down",(()=>this.changeModeIfNotAuto_("angle-y"))),s.emitter.on("up",(()=>this.changeModeIfNotAuto_("free")));const r=new G(this.view.zArcBElement);r.emitter.on("down",(()=>this.changeModeIfNotAuto_("angle-z"))),r.emitter.on("up",(()=>this.changeModeIfNotAuto_("free")));const a=new G(this.view.zArcFElement);a.emitter.on("down",(()=>this.changeModeIfNotAuto_("angle-z"))),a.emitter.on("up",(()=>this.changeModeIfNotAuto_("free")));const l=new G(this.view.rArcElement);l.emitter.on("down",(()=>this.changeModeIfNotAuto_("angle-r"))),l.emitter.on("up",(()=>this.changeModeIfNotAuto_("free"))),[{el:this.view.xLabel,q:Tt},{el:this.view.yLabel,q:Nt},{el:this.view.zLabel,q:It},{el:this.view.xnLabel,q:Yt},{el:this.view.ynLabel,q:Xt},{el:this.view.znLabel,q:Ht}].forEach((({el:t,q:e})=>{new G(t).emitter.on("down",(()=>this.autoRotate_(e)))})),this.px_=null,this.py_=null,this.angleState_=null}handlePointerEvent_(t){if(!t.point)return;const e=this.mode_.rawValue,i=t.point.x,n=t.point.y;if("auto"===e);else if("free"===e){if(null!=this.px_&&null!=this.py_){const t=i-this.px_,e=n-this.py_,o=Math.sqrt(t*t+e*e);if(0===o)return;const s=new gt(e/o,t/o,0),r=vt.fromAxisAngle(s,o/68);this.value.rawValue=this.value.rawValue.premultiply(r)}this.px_=i,this.py_=n}else if("angle-r"===e){const e=t.bounds.width/2,o=t.bounds.height/2,s=Math.atan2(n-o,i-e);if(null==this.angleState_){const t=new gt(0,0,1);this.angleState_={initialRotation:this.value.rawValue,initialAngle:s,axis:t,reverseAngle:!0}}else{const{initialRotation:t,initialAngle:e,axis:i}=this.angleState_,n=-dt(s-e),o=vt.fromAxisAngle(i,n);this.value.rawValue=t.premultiply(o)}}else{const o=t.bounds.width/2,s=t.bounds.height/2,r=Math.atan2(n-s,i-o);if(null==this.angleState_){const t="angle-x"===e?Kt:"angle-y"===e?qt:Dt,i=t.applyQuaternion(this.value.rawValue.quat).z>0;this.angleState_={initialRotation:this.value.rawValue,initialAngle:r,axis:t,reverseAngle:i}}else{const{initialRotation:t,initialAngle:e,axis:i,reverseAngle:n}=this.angleState_;let o=dt(r-e);o=n?-o:o;const s=vt.fromAxisAngle(i,o);this.value.rawValue=t.multiply(s)}}}onPointerDown_(t){this.handlePointerEvent_(t.data)}onPointerMove_(t){this.handlePointerEvent_(t.data)}onPointerUp_(){this.px_=null,this.py_=null,this.angleState_=null}onPadKeyDown_(t){var e;(function(t){return"ArrowUp"===t||"ArrowDown"===t}(e=t.key)||"ArrowLeft"===e||"ArrowRight"===e)&&t.preventDefault();const i=Q(1,function(t){return{altKey:t.altKey,downKey:"ArrowLeft"===t.key,shiftKey:t.shiftKey,upKey:"ArrowRight"===t.key}}(t)),n=Q(1,J(t));if(0!==i||0!==n){const t=new gt(-n,i,0),e=vt.fromAxisAngle(t,Math.PI/16);this.value.rawValue=this.value.rawValue.premultiply(e)}}changeModeIfNotAuto_(t){"auto"!==this.mode_.rawValue&&(this.mode_.rawValue=t)}autoRotate_(t){this.mode_.rawValue="auto";const e=this.value.rawValue,i=Date.now(),n=()=>{const o=Date.now(),s=function(t){if(t<=0)return 0;if(t>=1)return 1;const e=1-t;return St(1-e*(e*(e*(e*(e*(e*(-6*e+7)))))))}(St((o-i-(r=0))/(300-r)));var r;this.value.rawValue=e.slerp(t,s),1!==s?requestAnimationFrame(n):this.mode_.rawValue="free"};requestAnimationFrame(n)}}const $t=r("rotationswatch"),Ut=new gt(1,0,0),Ot=new gt(0,1,0),Qt=new gt(0,0,1),Jt=new vt(0,0,0,1);class Wt{constructor(t,e){this.onValueChange_=this.onValueChange_.bind(this),e.value.emitter.on("change",this.onValueChange_),this.value=e.value,this.element=t.createElement("div"),this.element.classList.add($t()),e.viewProps.bindClassModifiers(this.element);const i=t.createElement("button");i.classList.add($t("b")),e.viewProps.bindDisabled(i),this.element.appendChild(i),this.buttonElement=i;const n=t.createElementNS(b,"svg");n.classList.add($t("g")),i.appendChild(n),this.svgElem_=n,this.projector_=new mt,this.projector_.viewport=[0,0,20,20];const o=bt(0,Math.PI,33,"x","y"),s=bt(0,2*Math.PI,65,"x","y");this.rArc_=new _t(t,s,this.projector_),this.rArc_.element.classList.add($t("arcr")),n.appendChild(this.rArc_.element),this.rArc_.setRotation(Jt),this.xArc_=new _t(t,o,this.projector_),this.xArc_.element.classList.add($t("arc")),n.appendChild(this.xArc_.element),this.yArc_=new _t(t,o,this.projector_),this.yArc_.element.classList.add($t("arc")),n.appendChild(this.yArc_.element),this.zArc_=new _t(t,o,this.projector_),this.zArc_.element.classList.add($t("arc")),n.appendChild(this.zArc_.element),this.update_()}update_(){const t=this.value.rawValue.quat.normalized,e=Ut.applyQuaternion(t),i=Ot.applyQuaternion(t),n=Qt.applyQuaternion(t);this.xArc_.setRotation(wt(e,Qt)),this.yArc_.setRotation(wt(i,Qt)),this.zArc_.setRotation(wt(n,Qt))}onValueChange_(){this.update_()}}class Gt{constructor(t,e){this.value=e.value,this.viewProps=e.viewProps,this.view=new Wt(t,{value:this.value,viewProps:this.viewProps})}}const te=r("rotation");class ee{constructor(t,e){this.element=t.createElement("div"),this.element.classList.add(te()),e.foldable.bindExpandedClass(this.element,te(void 0,"expanded")),h(e.foldable,"completed",c(this.element,te(void 0,"cpl"))),"quaternion"===e.rotationMode&&this.element.classList.add(te("quat"));const i=t.createElement("div");i.classList.add(te("h")),this.element.appendChild(i);const n=t.createElement("div");n.classList.add(te("s")),i.appendChild(n),this.swatchElement=n;const o=t.createElement("div");if(o.classList.add(te("t")),i.appendChild(o),this.textElement=o,"inline"===e.pickerLayout){const e=t.createElement("div");e.classList.add(te("g")),this.element.appendChild(e),this.pickerElement=e}else this.pickerElement=null}}class ie{constructor(t,e){this.onButtonBlur_=this.onButtonBlur_.bind(this),this.onButtonClick_=this.onButtonClick_.bind(this),this.onPopupChildBlur_=this.onPopupChildBlur_.bind(this),this.onPopupChildKeydown_=this.onPopupChildKeydown_.bind(this),this.value=e.value,this.viewProps=e.viewProps,this.foldable_=y.create(e.expanded),this.swatchC_=new Gt(t,{value:this.value,viewProps:this.viewProps});const i=this.swatchC_.view.buttonElement;i.addEventListener("blur",this.onButtonBlur_),i.addEventListener("click",this.onButtonClick_),this.textC_=new lt(t,{assembly:e.assembly,axes:e.axes,parser:e.parser,value:this.value,viewProps:this.viewProps}),this.view=new ee(t,{rotationMode:e.rotationMode,foldable:this.foldable_,pickerLayout:e.pickerLayout}),this.view.swatchElement.appendChild(this.swatchC_.view.element),this.view.textElement.appendChild(this.textC_.view.element),this.popC_="popup"===e.pickerLayout?new M(t,{viewProps:this.viewProps}):null;const n=new Zt(t,{value:this.value,viewProps:this.viewProps,pickerLayout:e.pickerLayout});n.view.allFocusableElements.forEach((t=>{t.addEventListener("blur",this.onPopupChildBlur_),t.addEventListener("keydown",this.onPopupChildKeydown_)})),this.gizmoC_=n,this.popC_?(this.view.element.appendChild(this.popC_.view.element),this.popC_.view.element.appendChild(n.view.element),O({primary:this.foldable_.value("expanded"),secondary:this.popC_.shows,forward:t=>t.rawValue,backward:(t,e)=>e.rawValue})):this.view.pickerElement&&(this.view.pickerElement.appendChild(this.gizmoC_.view.element),z(this.foldable_,this.view.pickerElement))}onButtonBlur_(t){if(!this.popC_)return;const e=this.view.element,i=t.relatedTarget;i&&e.contains(i)||(this.popC_.shows.rawValue=!1)}onButtonClick_(){this.foldable_.set("expanded",!this.foldable_.get("expanded")),this.foldable_.get("expanded")&&this.gizmoC_.view.allFocusableElements[0].focus()}onPopupChildBlur_(t){if(!this.popC_)return;const e=this.popC_.view.element,i=function(t){return t.relatedTarget?t.relatedTarget:"explicitOriginalTarget"in t?t.explicitOriginalTarget:null}(t);i&&e.contains(i)||(i&&i===this.swatchC_.view.buttonElement&&void 0===e.ownerDocument.ontouchstart||(this.popC_.shows.rawValue=!1))}onPopupChildKeydown_(t){this.popC_?"Escape"===t.key&&(this.popC_.shows.rawValue=!1):this.view.pickerElement&&"Escape"===t.key&&this.swatchC_.view.buttonElement.focus()}}function ne(t,e){const i=Math.pow(.1,t);return{baseStep:i,constraint:e,textProps:v.fromObject({draggingScale:i,formatter:U(t)})}}function oe(t){if(!t)return;const i=[];return e(t.step)||i.push(new E(t.step)),e(t.max)&&e(t.min)||i.push(new C({max:t.max,min:t.min})),new A(i)}function se(t,e){return{toComponents:t=>t.getComponents(),fromComponents:i=>new pt(i[0],i[1],i[2],t,e)}}function re(t,e,i){var n,o,s;return"number"==typeof(null===(n=t)||void 0===n?void 0:n.x)&&"number"==typeof(null===(o=t)||void 0===o?void 0:o.y)&&"number"==typeof(null===(s=t)||void 0===s?void 0:s.z)?new pt(t.x,t.y,t.z,e,i):new pt(0,0,0,e,i)}function ae(t){switch(t){case"XYZ":case"XZY":case"YXZ":case"YZX":case"ZXY":case"ZYX":return t;default:return}}function le(t){switch(t){case"rad":case"deg":case"turn":return t;default:return}}const he={id:"rotation",type:"input",css:".tp-rotationswatchv_b,.tp-rotationgizmov_p{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border-width:0;font-family:inherit;font-size:inherit;font-weight:inherit;margin:0;outline:none;padding:0}.tp-rotationswatchv_b{background-color:var(--btn-bg);border-radius:var(--elm-br);color:var(--btn-fg);cursor:pointer;display:block;font-weight:bold;height:var(--bld-us);line-height:var(--bld-us);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.tp-rotationswatchv_b:hover{background-color:var(--btn-bg-h)}.tp-rotationswatchv_b:focus{background-color:var(--btn-bg-f)}.tp-rotationswatchv_b:active{background-color:var(--btn-bg-a)}.tp-rotationswatchv_b:disabled{opacity:0.5}.tp-rotationgizmov_p{background-color:var(--in-bg);border-radius:var(--elm-br);box-sizing:border-box;color:var(--in-fg);font-family:inherit;height:var(--bld-us);line-height:var(--bld-us);min-width:0;width:100%}.tp-rotationgizmov_p:hover{background-color:var(--in-bg-h)}.tp-rotationgizmov_p:focus{background-color:var(--in-bg-f)}.tp-rotationgizmov_p:active{background-color:var(--in-bg-a)}.tp-rotationgizmov_p:disabled{opacity:0.5}.tp-rotationv{position:relative}.tp-rotationv_quat .tp-txtv_i{padding-left:0}.tp-rotationv_root{background-color:var(--mo-bg);width:100%;height:calc( 2.0 * var(--bld-us))}.tp-rotationv_h{display:flex}.tp-rotationv_s{flex-grow:0;flex-shrink:0;width:var(--bld-us);margin-right:4px}.tp-rotationv_g{height:0;margin-top:0;opacity:0;overflow:hidden;transition:height .2s ease-in-out,opacity .2s linear,margin .2s ease-in-out}.tp-rotationv.tp-rotationv-expanded .tp-rotationv_g{margin-top:var(--bld-s);opacity:1}.tp-rotationv .tp-popv{left:calc(-1 * var(--cnt-h-p));right:calc(-1 * var(--cnt-h-p));top:var(--bld-us)}.tp-rotationswatchv path{stroke-linecap:round;stroke-linejoin:round}.tp-rotationswatchv_b{height:var(--bld-us);margin-right:4px;position:relative;width:var(--bld-us)}.tp-rotationswatchv_arc{fill:none;stroke:var(--btn-bg);stroke-width:1px}.tp-rotationswatchv_arcr{fill:var(--btn-fg);stroke:var(--btn-bg);stroke-width:1px}.tp-rotationgizmov{padding-left:calc(var(--bld-us) + 4px)}.tp-rotationgizmov path{stroke-linecap:round;stroke-linejoin:round}.tp-rotationgizmov_p{cursor:move;height:0;overflow:hidden;padding-bottom:100%;position:relative}.tp-rotationgizmov_g{display:block;height:100%;left:0;pointer-events:none;position:absolute;top:0;width:100%}.tp-rotationgizmov_axisx{stroke:#eb103f;stroke-width:2px}.tp-rotationgizmov_axisy{stroke:#4eeb10;stroke-width:2px}.tp-rotationgizmov_axisz{stroke:#1068eb;stroke-width:2px}.tp-rotationgizmov_axisn{stroke:var(--in-fg);stroke-width:2px}.tp-rotationgizmov_arcx{fill:none;stroke:var(--in-fg)}.tp-rotationgizmov_arcx.tp-rotationgizmov_arcx_hover{stroke:#eb103f}.tp-rotationgizmov_arcx.tp-rotationgizmov_arcx_active{stroke:#eb103f;stroke-width:2px}.tp-rotationgizmov_arcy{fill:none;stroke:var(--in-fg)}.tp-rotationgizmov_arcy.tp-rotationgizmov_arcy_hover{stroke:#4eeb10}.tp-rotationgizmov_arcy.tp-rotationgizmov_arcy_active{stroke:#4eeb10;stroke-width:2px}.tp-rotationgizmov_arcz{fill:none;stroke:var(--in-fg)}.tp-rotationgizmov_arcz.tp-rotationgizmov_arcz_hover{stroke:#1068eb}.tp-rotationgizmov_arcz.tp-rotationgizmov_arcz_active{stroke:#1068eb;stroke-width:2px}.tp-rotationgizmov_arcr{fill:none;stroke:var(--in-fg)}.tp-rotationgizmov_arcr.tp-rotationgizmov_arcr_hover{stroke:#ebd510}.tp-rotationgizmov_arcr.tp-rotationgizmov_arcr_active{stroke:#ebd510;stroke-width:2px}.tp-rotationgizmov_arcc{fill:none;stroke:transparent;stroke-width:5px;pointer-events:auto}.tp-rotationgizmov_labelcirclex{fill:#eb103f;cursor:pointer;pointer-events:auto}.tp-rotationgizmov_labelcirclex:hover{opacity:0.7}.tp-rotationgizmov_labelcircley{fill:#4eeb10;cursor:pointer;pointer-events:auto}.tp-rotationgizmov_labelcircley:hover{opacity:0.7}.tp-rotationgizmov_labelcirclez{fill:#1068eb;cursor:pointer;pointer-events:auto}.tp-rotationgizmov_labelcirclez:hover{opacity:0.7}.tp-rotationgizmov_labelcirclen{fill:var(--in-fg);cursor:pointer;pointer-events:auto}.tp-rotationgizmov_labelcirclen:hover{opacity:0.7}.tp-rotationgizmov_labeltext{fill:var(--btn-fg);stroke:var(--btn-fg);stroke-width:1px}.tp-rotationgizmov_p:focus .tp-rotationgizmov_m{background-color:var(--in-fg);border-width:0}",accept(t,e){var i,n;const o=g,s=w(e,{view:o.required.constant("rotation"),label:o.optional.string,picker:o.optional.custom(nt),expanded:o.optional.boolean,rotationMode:o.required.constant("euler"),x:o.optional.custom(ot),y:o.optional.custom(ot),z:o.optional.custom(ot),order:o.optional.custom(ae),unit:o.optional.custom(le)});return s?{initialValue:re(t,null!==(i=s.order)&&void 0!==i?i:"XYZ",null!==(n=s.unit)&&void 0!==n?n:"rad"),params:s}:null},binding:{reader:({params:t})=>e=>{var i,n;return re(e,null!==(i=t.order)&&void 0!==i?i:"XYZ",null!==(n=t.unit)&&void 0!==n?n:"rad")},constraint({params:t}){var e,i;return new st({assembly:se(null!==(e=t.order)&&void 0!==e?e:"XYZ",null!==(i=t.unit)&&void 0!==i?i:"rad"),components:[oe("x"in t?t.x:void 0),oe("y"in t?t.y:void 0),oe("z"in t?t.z:void 0)]})},writer:t=>(t,e)=>{t.writeProperty("x",e.x),t.writeProperty("y",e.y),t.writeProperty("z",e.z)}},controller({document:t,value:e,constraint:i,params:o,viewProps:s}){var r,a;if(!(i instanceof st))throw n.shouldNeverHappen();const l="expanded"in o?o.expanded:void 0,h="picker"in o?o.picker:void 0,c=null!==(r=o.unit)&&void 0!==r?r:"rad",u={rad:2,deg:0,turn:2}[c];return new ie(t,{axes:[ne(u,i.components[0]),ne(u,i.components[1]),ne(u,i.components[2])],assembly:se(null!==(a=o.order)&&void 0!==a?a:"XYZ",c),rotationMode:"euler",expanded:null!=l&&l,parser:$,pickerLayout:null!=h?h:"popup",value:e,viewProps:s})}},ce={toComponents:t=>[t.x,t.y,t.z,t.w],fromComponents:t=>new vt(t[0],t[1],t[2],t[3])};function ue(t){return{baseStep:.01,constraint:t,textProps:v.fromObject({draggingScale:.01,formatter:t=>Math.abs(t)<.995?t.toFixed(2).replace("0.","."):t.toFixed(1)})}}function de(t){var e,i,n,o;return"number"==typeof(null===(e=t)||void 0===e?void 0:e.x)&&"number"==typeof(null===(i=t)||void 0===i?void 0:i.y)&&"number"==typeof(null===(n=t)||void 0===n?void 0:n.z)&&"number"==typeof(null===(o=t)||void 0===o?void 0:o.w)?new vt(t.x,t.y,t.z,t.w):new vt(0,0,0,1)}const pe={id:"rotation",type:"input",css:".tp-rotationswatchv_b,.tp-rotationgizmov_p{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border-width:0;font-family:inherit;font-size:inherit;font-weight:inherit;margin:0;outline:none;padding:0}.tp-rotationswatchv_b{background-color:var(--btn-bg);border-radius:var(--elm-br);color:var(--btn-fg);cursor:pointer;display:block;font-weight:bold;height:var(--bld-us);line-height:var(--bld-us);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.tp-rotationswatchv_b:hover{background-color:var(--btn-bg-h)}.tp-rotationswatchv_b:focus{background-color:var(--btn-bg-f)}.tp-rotationswatchv_b:active{background-color:var(--btn-bg-a)}.tp-rotationswatchv_b:disabled{opacity:0.5}.tp-rotationgizmov_p{background-color:var(--in-bg);border-radius:var(--elm-br);box-sizing:border-box;color:var(--in-fg);font-family:inherit;height:var(--bld-us);line-height:var(--bld-us);min-width:0;width:100%}.tp-rotationgizmov_p:hover{background-color:var(--in-bg-h)}.tp-rotationgizmov_p:focus{background-color:var(--in-bg-f)}.tp-rotationgizmov_p:active{background-color:var(--in-bg-a)}.tp-rotationgizmov_p:disabled{opacity:0.5}.tp-rotationv{position:relative}.tp-rotationv_quat .tp-txtv_i{padding-left:0}.tp-rotationv_root{background-color:var(--mo-bg);width:100%;height:calc( 2.0 * var(--bld-us))}.tp-rotationv_h{display:flex}.tp-rotationv_s{flex-grow:0;flex-shrink:0;width:var(--bld-us);margin-right:4px}.tp-rotationv_g{height:0;margin-top:0;opacity:0;overflow:hidden;transition:height .2s ease-in-out,opacity .2s linear,margin .2s ease-in-out}.tp-rotationv.tp-rotationv-expanded .tp-rotationv_g{margin-top:var(--bld-s);opacity:1}.tp-rotationv .tp-popv{left:calc(-1 * var(--cnt-h-p));right:calc(-1 * var(--cnt-h-p));top:var(--bld-us)}.tp-rotationswatchv path{stroke-linecap:round;stroke-linejoin:round}.tp-rotationswatchv_b{height:var(--bld-us);margin-right:4px;position:relative;width:var(--bld-us)}.tp-rotationswatchv_arc{fill:none;stroke:var(--btn-bg);stroke-width:1px}.tp-rotationswatchv_arcr{fill:var(--btn-fg);stroke:var(--btn-bg);stroke-width:1px}.tp-rotationgizmov{padding-left:calc(var(--bld-us) + 4px)}.tp-rotationgizmov path{stroke-linecap:round;stroke-linejoin:round}.tp-rotationgizmov_p{cursor:move;height:0;overflow:hidden;padding-bottom:100%;position:relative}.tp-rotationgizmov_g{display:block;height:100%;left:0;pointer-events:none;position:absolute;top:0;width:100%}.tp-rotationgizmov_axisx{stroke:#eb103f;stroke-width:2px}.tp-rotationgizmov_axisy{stroke:#4eeb10;stroke-width:2px}.tp-rotationgizmov_axisz{stroke:#1068eb;stroke-width:2px}.tp-rotationgizmov_axisn{stroke:var(--in-fg);stroke-width:2px}.tp-rotationgizmov_arcx{fill:none;stroke:var(--in-fg)}.tp-rotationgizmov_arcx.tp-rotationgizmov_arcx_hover{stroke:#eb103f}.tp-rotationgizmov_arcx.tp-rotationgizmov_arcx_active{stroke:#eb103f;stroke-width:2px}.tp-rotationgizmov_arcy{fill:none;stroke:var(--in-fg)}.tp-rotationgizmov_arcy.tp-rotationgizmov_arcy_hover{stroke:#4eeb10}.tp-rotationgizmov_arcy.tp-rotationgizmov_arcy_active{stroke:#4eeb10;stroke-width:2px}.tp-rotationgizmov_arcz{fill:none;stroke:var(--in-fg)}.tp-rotationgizmov_arcz.tp-rotationgizmov_arcz_hover{stroke:#1068eb}.tp-rotationgizmov_arcz.tp-rotationgizmov_arcz_active{stroke:#1068eb;stroke-width:2px}.tp-rotationgizmov_arcr{fill:none;stroke:var(--in-fg)}.tp-rotationgizmov_arcr.tp-rotationgizmov_arcr_hover{stroke:#ebd510}.tp-rotationgizmov_arcr.tp-rotationgizmov_arcr_active{stroke:#ebd510;stroke-width:2px}.tp-rotationgizmov_arcc{fill:none;stroke:transparent;stroke-width:5px;pointer-events:auto}.tp-rotationgizmov_labelcirclex{fill:#eb103f;cursor:pointer;pointer-events:auto}.tp-rotationgizmov_labelcirclex:hover{opacity:0.7}.tp-rotationgizmov_labelcircley{fill:#4eeb10;cursor:pointer;pointer-events:auto}.tp-rotationgizmov_labelcircley:hover{opacity:0.7}.tp-rotationgizmov_labelcirclez{fill:#1068eb;cursor:pointer;pointer-events:auto}.tp-rotationgizmov_labelcirclez:hover{opacity:0.7}.tp-rotationgizmov_labelcirclen{fill:var(--in-fg);cursor:pointer;pointer-events:auto}.tp-rotationgizmov_labelcirclen:hover{opacity:0.7}.tp-rotationgizmov_labeltext{fill:var(--btn-fg);stroke:var(--btn-fg);stroke-width:1px}.tp-rotationgizmov_p:focus .tp-rotationgizmov_m{background-color:var(--in-fg);border-width:0}",accept(t,e){const i=g,n=w(e,{view:i.required.constant("rotation"),label:i.optional.string,picker:i.optional.custom(nt),expanded:i.optional.boolean,rotationMode:i.optional.constant("quaternion"),x:i.optional.custom(ot),y:i.optional.custom(ot),z:i.optional.custom(ot),w:i.optional.custom(ot)});return n?{initialValue:de(t),params:n}:null},binding:{reader:t=>t=>de(t),constraint:({params:t})=>new st({assembly:ce,components:[oe("x"in t?t.x:void 0),oe("y"in t?t.y:void 0),oe("z"in t?t.z:void 0),oe("w"in t?t.w:void 0)]}),writer:t=>(t,e)=>{t.writeProperty("x",e.x),t.writeProperty("y",e.y),t.writeProperty("z",e.z),t.writeProperty("w",e.w)}},controller({document:t,value:e,constraint:i,params:o,viewProps:s}){if(!(i instanceof st))throw n.shouldNeverHappen();const r="expanded"in o?o.expanded:void 0,a="picker"in o?o.picker:void 0;return new ie(t,{axes:[ue(i.components[0]),ue(i.components[1]),ue(i.components[2]),ue(i.components[3])],assembly:ce,rotationMode:"quaternion",expanded:null!=r&&r,parser:$,pickerLayout:null!=a?a:"popup",value:e,viewProps:s})}},ve=[he,pe];t.RotationInputPluginEuler=he,t.RotationInputPluginQuaternion=pe,t.plugins=ve,Object.defineProperty(t,"__esModule",{value:!0})}));
